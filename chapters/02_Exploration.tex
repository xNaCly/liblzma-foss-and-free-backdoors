% https://medium.com/@knownsec404team/analysis-of-the-xz-utils-backdoor-code-d2d5316ac43f
% https://www.openwall.com/lists/oss-security/2024/03/29/4
% https://research.swtch.com/xz-script
% https://www.reddit.com/r/programming/comments/1bv8k7f/the_role_of_ifunc_in_the_xz_backdoor/
% https://github.com/openssl/openssl/blob/master/crypto/rsa/rsa_crpt.c#L51
% https://gitlab.com/cy4n/talk-backdoorxz-pub/-/raw/main/xz_gpn.pdf
% https://gist.github.com/thesamesam/223949d5a074ebc3dce9ee78baad9e27
\section{Backdoor Exploration}

According to \cite{wysopal2007static}, a backdoor refers to a hidden method of
gaining entry to a system bypassing security measures, such as biometric or
password based authentication. They can be implemented in cryptographic
algorithms, on the hardware level or in an application. Backdoors can be used
to remotely access systems and are often hidden inside commonly used
non-malicious software.

\subsection{Implementation}

\texttt{CVE-2024-3094} was assigned to the \texttt{libzlma} backdoor with the
highest possible CVSS Score: $10.0$. This assessement was made due to the
severness of the included remote code execution \cite{redhat2024cve}. The
sophistication of this backdoor suggests a highly proficient attacker known by
several confirmed aliases, such as \textit{Jia Tan} (\texttt{JiaT75}),
\textit{Jigar Kumar}, \texttt{krygorin4545}, \texttt{misoeater91} and
\textit{Hans Jansen} \cite{arstechnica2024xzutils}.

\subsection{Social Engineering \& Pressure on OSS Maintainer}

The process of injecting oneself into the group of maintainers of a open source
software project is a complicated and tedious one. OSS-projects are often led
by a close group of individuals, which often proved themselves by contributing
constructive additions over a long period of time.

A threat actor, whether state-sponsored or a group of individuals, most often
do not take this approach to tampering with software for the purpose of
implementing a backdoor. However this particular backdoor was implemented with
said path over the course of three years.

Specifically the threat actor abused the mental state of the lead maintainer by
applying pressure on them via sock puppet accounts\footnote{false online
identity created and used specifically for deceptive purposes} and depicting
the project changes made by the lead maintainer as slow and not begin up to
date enough. Using said pressure in combination with the maintainers mental
health issues enabled the threat actor to gain the trust and therefore the
co-maintainer position \cite{arstechnica2024xzutils}. 

This position allowed the threat actor to make changes to the build-pipeline,
test files and to sign-off and release versions of the software itself to the
public.

\subsection{Build Pipeline Manipulation}

As introduced before, the attacker uses this privileged position in the
maintainer group to make changes to the test files by introducing a file
called \texttt{build-to-host.m4}\footnote{unix macro processor used in
\texttt{autoconf} \cite{gnu2021m4}} \footnote{produces scripts to configure
software \cite{gnu2020autoconf}}. This file is included in the package
release, but not in the version controlled repository. Furthermore the
threat actor embeds obfuscated and encrypted stages of the backdoor in two
test files called \texttt{bad-3-corrupt\_lzma2.xz} and
\texttt{good-large\_compressed.lzma}.

\begin{figure}[H]
    \centering
    \begin{tabular}{c c c}
        Byte & ASCII & Substitution \\
        \hline
        \texttt{0x09} & \texttt{"\textbackslash t"} & \texttt{0x20}\\
        \texttt{0x20} & \texttt{" "} & \texttt{0x09} \\
        \texttt{0x2d} & \texttt{"-"} & \texttt{0x5f} \\
        \texttt{0x5f} & \texttt{"\_"} & \texttt{0x2d} \\
    \end{tabular}
    \label{table:replacements}
    \caption{Substitution table according to \cite{arstechnica2024xzutils}}
\end{figure}

The aforementioned macro is executed during the build process and
substitutes characters in the \texttt{bad-3-corrupt\_lzma2.xz} file, as
shown in \autoref{table:replacements}. Upon having performed the
substitution, the \texttt{.xz} file is decoded and ready for the first stage
of the backdoor. 

\subsection{IFUNC \& CPU specific Features}

\begin{itemize}
    \item IFUNC is used to switch to a hardware supported function implementation at runtime
    \item abused by the attacker to replace the \texttt{openssh} function \texttt{RSA\_public\_decrypt()}
    \item replaced with execution of injected shell code via \texttt{system()}
\end{itemize}

\subsection{Indirect Dependence on libzlma}

\begin{itemize}
    \item \texttt{openssh} does not depend on \texttt{libzlma}
    \item common patches link \texttt{openssh} dynamically against \texttt{libsystemd}, which links agains \texttt{liblzma}
    \item making \texttt{openssh} vulnerable via indirect dependence
\end{itemize}

\subsection{Modifying ELF \& Executing Shell Code}

\subsection{Prerequisites for the Backdoor}

\begin{itemize}
    \item built with \texttt{GCC} and \texttt{glibc}
    \item shared object is opened on \texttt{x86-64}
    \item built by \texttt{dpkg} or \texttt{rpm}
\end{itemize}

